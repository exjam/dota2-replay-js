<html>
<head>
<script src="Long.js/Long.js"></script>
<script src="ByteBuffer.js/ByteBuffer.js"></script>
<script src="ProtoBuf.js/ProtoBuf.js"></script>
<script src="uncompress.js"></script>
</head>
<body>
   <input type="file" id="files" name="files[]" multiple />
<output id="list"></output>

<script>
  var EBaseUserMessages = {
      UM_AchievementEvent : 1,
      UM_CloseCaption : 2,
      UM_CloseCaptionDirect : 3,
      UM_CurrentTimescale : 4,
      UM_DesiredTimescale : 5,
      UM_Fade : 6,
      UM_GameTitle : 7,
      UM_Geiger : 8,
      UM_HintText : 9,
      UM_HudMsg : 10,
      UM_HudText : 11,
      UM_KeyHintText : 12,
      UM_MessageText : 13,
      UM_RequestState : 14,
      UM_ResetHUD : 15,
      UM_Rumble : 16,
      UM_SayText : 17,
      UM_SayText2 : 18,
      UM_SayTextChannel : 19,
      UM_Shake : 20,
      UM_ShakeDir : 21,
      UM_StatsCrawlMsg : 22,
      UM_StatsSkipState : 23,
      UM_TextMsg : 24,
      UM_Tilt : 25,
      UM_Train : 26,
      UM_VGUIMenu : 27,
      UM_VoiceMask : 28,
      UM_VoiceSubtitle : 29,
      UM_SendAudio : 30,
      UM_MAX_BASE : 63,
  };

  var EDotaUserMessages = {
      DOTA_UM_AddUnitToSelection : 64,
      DOTA_UM_AIDebugLine : 65,
      DOTA_UM_ChatEvent : 66,
      DOTA_UM_CombatHeroPositions : 67,
      DOTA_UM_CombatLogData : 68,
      DOTA_UM_CombatLogShowDeath : 70,
      DOTA_UM_CreateLinearProjectile : 71,
      DOTA_UM_DestroyLinearProjectile : 72,
      DOTA_UM_DodgeTrackingProjectiles : 73,
      DOTA_UM_GlobalLightColor : 74,
      DOTA_UM_GlobalLightDirection : 75,
      DOTA_UM_InvalidCommand : 76,
      DOTA_UM_LocationPing : 77,
      DOTA_UM_MapLine : 78,
      DOTA_UM_MiniKillCamInfo : 79,
      DOTA_UM_MinimapDebugPoint : 80,
      DOTA_UM_MinimapEvent : 81,
      DOTA_UM_NevermoreRequiem : 82,
      DOTA_UM_OverheadEvent : 83,
      DOTA_UM_SetNextAutobuyItem : 84,
      DOTA_UM_SharedCooldown : 85,
      DOTA_UM_SpectatorPlayerClick : 86,
      DOTA_UM_TutorialTipInfo : 87,
      DOTA_UM_UnitEvent : 88,
      DOTA_UM_ParticleManager : 89,
      DOTA_UM_BotChat : 90,
      DOTA_UM_HudError : 91,
      DOTA_UM_ItemPurchased : 92,
      DOTA_UM_Ping : 93,
      DOTA_UM_ItemFound : 94,
      DOTA_UM_CharacterSpeakConcept : 95,
      DOTA_UM_SwapVerify : 96,
      DOTA_UM_WorldLine : 97,
      DOTA_UM_TournamentDrop : 98,
      DOTA_UM_ItemAlert : 99,
      DOTA_UM_HalloweenDrops : 100,
      DOTA_UM_ChatWheel : 101,
      DOTA_UM_ReceivedXmasGift : 102,
      DOTA_UM_UpdateSharedContent : 103,
      DOTA_UM_TutorialRequestExp : 104,
      DOTA_UM_TutorialPingMinimap : 105,
      DOTA_UM_GamerulesStateChanged : 106,
      DOTA_UM_ShowSurvey : 107,
      DOTA_UM_TutorialFade : 108,
      DOTA_UM_AddQuestLogEntry : 109,
      DOTA_UM_SendStatPopup : 110,
      DOTA_UM_TutorialFinish : 111,
      DOTA_UM_SendRoshanPopup : 112,
      DOTA_UM_SendGenericToolTip : 113,
      DOTA_UM_SendFinalGold : 114,
      DOTA_UM_CustomMsg : 115,
      DOTA_UM_CoachHUDPing : 116,
      DOTA_UM_ClientLoadGridNav : 117,
      DOTA_UM_AbilityPing : 118,
      DOTA_UM_ShowGenericPopup : 119,
      DOTA_UM_VoteStart : 120,
      DOTA_UM_VoteUpdate : 121,
      DOTA_UM_VoteEnd : 122,
  };

  var userMessages = [];

  userMessages[EBaseUserMessages.UM_TextMsg] = { proto: "CUserMsg_TextMsg" };

  var demoPackets = [];
  var embdPackets = [];

  var EDemoCommands ={
    DEM_Error : -1,
    DEM_Stop : 0,
    DEM_FileHeader : 1,
    DEM_FileInfo : 2,
    DEM_SyncTick : 3,
    DEM_SendTables : 4,
    DEM_ClassInfo : 5,
    DEM_StringTables : 6,
    DEM_Packet : 7,
    DEM_SignonPacket : 8,
    DEM_ConsoleCmd : 9,
    DEM_CustomData : 10,
    DEM_CustomDataCallbacks : 11,
    DEM_UserCmd : 12,
    DEM_FullPacket : 13,
    DEM_SaveGame : 14,
    DEM_Max : 15,
    DEM_IsCompressed : 112,
  };

  //demoPackets[EDemoCommands.DEM_Error]   = { proto: "" }; ? where r u
  demoPackets[EDemoCommands.DEM_Stop]         = { proto: "CDemoStop" };
  demoPackets[EDemoCommands.DEM_FileHeader]   = { proto: "CDemoFileHeader" };
  demoPackets[EDemoCommands.DEM_FileInfo]     = { proto: "CDemoFileInfo" };
  demoPackets[EDemoCommands.DEM_SyncTick]     = { proto: "CDemoSyncTick", ignore: true };
  demoPackets[EDemoCommands.DEM_SendTables]   = { proto: "CDemoSendTables", embedded: true };
  demoPackets[EDemoCommands.DEM_ClassInfo]    = { proto: "CDemoClassInfo" };
  demoPackets[EDemoCommands.DEM_StringTables] = { proto: "CDemoStringTables", func: readDemoStringTables };
  demoPackets[EDemoCommands.DEM_Packet]       = { proto: "CDemoPacket", embedded: true };
  demoPackets[EDemoCommands.DEM_SignonPacket] = { proto: "CDemoPacket", embedded: true };
  demoPackets[EDemoCommands.DEM_ConsoleCmd]   = { proto: "CDemoConsoleCmd" };
  demoPackets[EDemoCommands.DEM_CustomData]   = { proto: "CDemoCustomData" };
  demoPackets[EDemoCommands.DEM_CustomDataCallbacks] = { proto: "CDemoCustomDataCallbacks" };
  demoPackets[EDemoCommands.DEM_UserCmd]      = { proto: "CDemoUserCmd" };
  demoPackets[EDemoCommands.DEM_FullPacket]   = { proto: "CDemoFullPacket" };
  demoPackets[EDemoCommands.DEM_SaveGame]     = { proto: "CDemoSaveGame" };

  var NET_Messages = {
    net_NOP : 0,
    net_Disconnect : 1,
    net_File : 2,
    net_SplitScreenUser : 3,
    net_Tick : 4,
    net_StringCmd : 5,
    net_SetConVar : 6,
    net_SignonState : 7,
  };

  embdPackets[NET_Messages.net_NOP] = { proto: "CNETMsg_NOP", ignore: true };
  embdPackets[NET_Messages.net_Disconnect] = { proto: "CNETMsg_Disconnect" };
  embdPackets[NET_Messages.net_File] = { proto: "CNETMsg_File" };
  embdPackets[NET_Messages.net_SplitScreenUser] = { proto: "CNETMsg_SplitScreenUser" };
  embdPackets[NET_Messages.net_Tick] = { proto: "CNETMsg_Tick" };
  embdPackets[NET_Messages.net_StringCmd] = { proto: "CNETMsg_StringCmd" };
  embdPackets[NET_Messages.net_SetConVar] = { proto: "CNETMsg_SetConVar" };
  embdPackets[NET_Messages.net_SignonState] = { proto: "CNETMsg_SignonState" };

  var SVC_Messages = {
    svc_ServerInfo : 8,
    svc_SendTable : 9,
    svc_ClassInfo : 10,
    svc_SetPause : 11,
    svc_CreateStringTable : 12,
    svc_UpdateStringTable : 13,
    svc_VoiceInit : 14,
    svc_VoiceData : 15,
    svc_Print : 16,
    svc_Sounds : 17,
    svc_SetView : 18,
    svc_FixAngle : 19,
    svc_CrosshairAngle : 20,
    svc_BSPDecal : 21,
    svc_SplitScreen : 22,
    svc_UserMessage : 23,
    svc_EntityMessage : 24,
    svc_GameEvent : 25,
    svc_PacketEntities : 26,
    svc_TempEntities : 27,
    svc_Prefetch : 28,
    svc_Menu : 29,
    svc_GameEventList : 30,
    svc_GetCvarValue : 31,
    svc_PacketReliable : 32,
  };

  embdPackets[SVC_Messages.svc_ServerInfo] = { proto: "CSVCMsg_ServerInfo" };
  embdPackets[SVC_Messages.svc_SendTable] = { proto: "CSVCMsg_SendTable" };
  embdPackets[SVC_Messages.svc_ClassInfo] = { proto: "CSVCMsg_ClassInfo" };
  embdPackets[SVC_Messages.svc_SetPause] = { proto: "CSVCMsg_SetPause" };
  embdPackets[SVC_Messages.svc_CreateStringTable] = { proto: "CSVCMsg_CreateStringTable", func: readCreateStringTable };
  embdPackets[SVC_Messages.svc_UpdateStringTable] = { proto: "CSVCMsg_UpdateStringTable" };
  embdPackets[SVC_Messages.svc_VoiceInit] = { proto: "CSVCMsg_VoiceInit" };
  embdPackets[SVC_Messages.svc_VoiceData] = { proto: "CSVCMsg_VoiceData" };
  embdPackets[SVC_Messages.svc_Print] = { proto: "CSVCMsg_Print" };
  embdPackets[SVC_Messages.svc_Sounds] = { proto: "CSVCMsg_Sounds" };
  embdPackets[SVC_Messages.svc_SetView] = { proto: "CSVCMsg_SetView" };
  embdPackets[SVC_Messages.svc_FixAngle] = { proto: "CSVCMsg_FixAngle" };
  embdPackets[SVC_Messages.svc_CrosshairAngle] = { proto: "CSVCMsg_CrosshairAngle" };
  embdPackets[SVC_Messages.svc_BSPDecal] = { proto: "CSVCMsg_BSPDecal" };
  embdPackets[SVC_Messages.svc_SplitScreen] = { proto: "CSVCMsg_SplitScreen" };
  embdPackets[SVC_Messages.svc_UserMessage] = { proto: "CSVCMsg_UserMessage", func: readUserMessage };
  //embdPackets[SVC_Messages.svc_EntityMessage] = { proto: "" }; ? where r u
  embdPackets[SVC_Messages.svc_GameEvent] = { proto: "CSVCMsg_GameEvent" };
  embdPackets[SVC_Messages.svc_PacketEntities] = { proto: "CSVCMsg_PacketEntities" };
  embdPackets[SVC_Messages.svc_TempEntities] = { proto: "CSVCMsg_TempEntities" };
  embdPackets[SVC_Messages.svc_Prefetch] = { proto: "CSVCMsg_Prefetch" };
  embdPackets[SVC_Messages.svc_Menu] = { proto: "CSVCMsg_Menu" };
  embdPackets[SVC_Messages.svc_GameEventList] = { proto: "CSVCMsg_GameEventList" };
  embdPackets[SVC_Messages.svc_GetCvarValue] = { proto: "CSVCMsg_GetCvarValue" };
  embdPackets[SVC_Messages.svc_PacketReliable] = { proto: "CSVCMsg_PacketReliable" };

  var ProtoBuf = dcodeIO.ProtoBuf;
  var ByteBuffer = dcodeIO.ByteBuffer;

  var pbDota2 = ProtoBuf.loadProtoFile("dota2.proto");

  function readPacket(byteBuffer)
  {
    var kind = byteBuffer.readVarint();
    var comp = ((kind & EDemoCommands.DEM_IsCompressed) == EDemoCommands.DEM_IsCompressed);
    var tick = byteBuffer.readVarint();
    var size = byteBuffer.readVarint();
    kind &= EDemoCommands.DEM_Max;

    console.log("Kind: " + kind + " tick: " + tick + " size: " + size);

    if (kind in demoPackets && demoPackets[kind].ignore != true) {
      var msg = pbDota2.build(demoPackets[kind].proto);
      var buf;

      if (comp) {
        console.log("Compressed!");

        try {
          buf = uncompress(new Uint8Array(byteBuffer.array, byteBuffer.offset, size));
          buf = ByteBuffer.wrap(buf.buffer);
        } catch(error) {
          console.log("snappy_uncompress error: " + error);
          buf = null;
        }
      } else {
        buf = byteBuffer.slice(byteBuffer.offset, byteBuffer.offset + size);
      }

      if (buf != null) {
        var decoded;

        try {
          decoded = msg.decode(buf);
          console.log(decoded);
        } catch (error) {
          console.log("protobuf decode error: " + error);
        }

        if (demoPackets[kind].embedded) {
          buf = decoded.data.clone();

          while (buf.offset < buf.length) {
            readEmbeddedPacket(buf);
          }
        } else if (demoPackets[kind].func != undefined) {
          demoPackets[kind].func(decoded);
        }
      }
    }

    byteBuffer.offset += size;
  }

  function readEmbeddedPacket(byteBuffer)
  {
    var kind = byteBuffer.readVarint();
    var size = byteBuffer.readVarint();
    var start = byteBuffer.offset;

    if (byteBuffer.offset + size > byteBuffer.length) {
      console.log("attempt to read past end of byteBuffer!!!");
    } else if (kind in embdPackets && embdPackets[kind].ignore != true) {
      var msg = pbDota2.build(embdPackets[kind].proto);
      var buf = byteBuffer.slice(byteBuffer.offset, byteBuffer.offset + size);

      try {
        var decoded = msg.decode(buf);
        console.log(decoded);

        if (embdPackets[kind].func != undefined) {
          embdPackets[kind].func(decoded);
        }
      } catch (error) {
        console.log("protobuf decode error: " + error);
      }
    }

    byteBuffer.offset = start + size;
  }

  function readUserMessage(msg) 
  {
    var type = msg.msg_type;
    var data = msg.msg_data;

    if (type in userMessages && userMessages[type].ignore != true) {
      var userMsg = pbDota2.build(userMessages[type].proto);
      var decoded = userMsg.decode(data);
      console.log(decoded);

      if (userMessages[kind].func != undefined) {
        userMessages[kind].func(decoded);
      }
    }

    console.log("USER MESSAGE: " + type);
  }

  function readCreateStringTable(msg)
  {
    /*var stringData = msg.string_data;
    var hex = "";
    while (stringData.remaining()) {
      hex += stringData.readUint8().toString(16);
    }
    console.log(hex);*/
  }

  function readDemoStringTables(msg)
  {      
/*
    ("xuid", ctypes.c_ulonglong),
      ("name", ctypes.c_char * 32),
      ("userID", ctypes.c_int32),
      ("guid", ctypes.c_char * 33),
      ("friendsID", ctypes.c_uint32),
      ("friendsName", ctypes.c_char * 32),
      ("fakeplayer", ctypes.c_bool),
      ("ishltv", ctypes.c_bool),
      ("customFiles", ctypes.c_uint32 * 4),
      ("filesDownloaded", ctypes.c_ubyte),
*/
    for (var i = 0; i < msg.tables.length; ++i) {
      if (msg.tables[i].table_name == "userinfo") {
        for (var j = 0; j < msg.tables[i].items.length; ++j) {
          var data = msg.tables[i].items[j].data;
          var userinfo = {};
          userinfo.xuid = data.readUint64();
          userinfo.name = data.readUTF8StringBytes(32);
          userinfo.userID = data.readUint32();
          userinfo.guid = data.readUTF8StringBytes(33);
          userinfo.friendsID = data.readUint32();
          userinfo.friendsName = data.readUTF8StringBytes(32);
          userinfo.fakeplayer = data.readUint32();
          userinfo.ishltv = data.readUint32();
          userinfo.customFiles = [];
          userinfo.customFiles[0] = data.readUint32();
          userinfo.customFiles[1] = data.readUint32();
          userinfo.customFiles[2] = data.readUint32();
          userinfo.customFiles[3] = data.readUint32();
          userinfo.filesDownloaded = data.readUint8();
          console.log("DEMOSTRINGTABLES USERINFO MOTHERFUCKER");
          console.log(userinfo);
        }
      }
    }
    console.log("DEMOSTRINGTABLES");
    console.log(msg.tables);
  }

  function handleFileSelect(evt)
  {
    var files = evt.target.files;

    for (var i = 0, f; f = files[i]; i++) {
      var reader = new FileReader();

      reader.onload = function(e) {
        var byteBuffer = ByteBuffer.wrap(reader.result);

        var header = byteBuffer.readUTF8StringBytes(8);
        var offset = byteBuffer.readUint32();

        console.log("Header: " + header);
        console.log("Offset: " + offset);

        for (var i = 0; i < 1000; ++i) {
          readPacket(byteBuffer);
        }
      }

      reader.readAsArrayBuffer(f);
    }
  }

  document.getElementById('files').addEventListener('change', handleFileSelect, false);
</script>
</body>
</html>